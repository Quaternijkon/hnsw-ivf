# Faiss 磁盘 vs 内存磁盘对比实验使用指南

## 快速开始

### 1. 环境检查
```bash
# 运行快速测试检查环境
./quick_test.sh
```

### 2. 运行完整对比实验
```bash
# 运行磁盘 vs 内存磁盘对比实验
./simple_disk_memory_test.sh
```

### 3. 分析结果
```bash
# 分析实验结果
python3 analyze_results.py disk_results.csv memory_results.csv
```

## 文件说明

### 主要脚本
- `quick_test.sh`: 快速环境检查
- `simple_disk_memory_test.sh`: 主要对比实验脚本
- `analyze_results.py`: 结果分析脚本

### 输出文件
- `disk_results.csv`: 普通磁盘测试结果
- `memory_results.csv`: 内存磁盘测试结果
- `performance_comparison.csv`: 性能对比数据
- `detailed_analysis_report.md`: 详细分析报告

## 实验原理

### 内存磁盘 (tmpfs)
- 使用Linux tmpfs在内存中创建虚拟磁盘
- 数据存储在RAM中，访问速度接近内存
- 消除磁盘I/O瓶颈，测试纯计算性能

### 对比方法
1. 相同程序在不同存储介质上运行
2. 对比QPS、延迟、功耗等关键指标
3. 分析高线程数下的性能差异
4. 识别磁盘I/O瓶颈

## 预期结果

### 如果存在磁盘I/O瓶颈
```
线程数 | 普通磁盘QPS | 内存磁盘QPS | 性能提升
-------|-------------|-------------|----------
1      | 1000        | 1000        | 0%
8      | 2000        | 2500        | 25%
16     | 3000        | 4500        | 50%
20     | 3500        | 6000        | 71%
```

### 如果磁盘I/O不是瓶颈
```
线程数 | 普通磁盘QPS | 内存磁盘QPS | 性能提升
-------|-------------|-------------|----------
1      | 1000        | 1000        | 0%
8      | 2000        | 2050        | 2.5%
16     | 3000        | 3100        | 3.3%
20     | 3500        | 3600        | 2.9%
```

## 故障排除

### 常见问题
1. **权限问题**: 需要sudo权限创建tmpfs
2. **内存不足**: 确保有足够内存创建2GB tmpfs
3. **数据文件缺失**: 确保sift目录下有必要的.fbin文件
4. **编译错误**: 确保Faiss库正确安装

### 调试命令
```bash
# 检查内存磁盘
df -h | grep tmpfs

# 检查数据文件
ls -la sift/

# 检查可执行文件
./benchmark-thread --help

# 查看测试日志
cat disk_test.log
cat memory_test.log
```

## 结果解读

### 性能提升计算
```
性能提升% = (内存磁盘QPS - 普通磁盘QPS) / 普通磁盘QPS × 100%
```

### 瓶颈程度判断
- **< 5%**: 磁盘I/O不是瓶颈
- **5-20%**: 存在轻微磁盘I/O瓶颈
- **20-50%**: 存在明显磁盘I/O瓶颈
- **> 50%**: 存在严重磁盘I/O瓶颈

## 优化建议

### 如果存在磁盘I/O瓶颈
1. **硬件升级**: 使用SSD、增加内存、使用NVMe
2. **软件优化**: 内存映射文件、增加缓存、优化I/O调度
3. **配置调整**: 减少并发线程、使用异步I/O

### 如果磁盘I/O不是瓶颈
1. **CPU优化**: 优化算法、使用SIMD、调整线程配置
2. **内存优化**: 优化访问模式、减少分配、使用内存池

## 实验扩展

### 高级实验
1. **不同存储设备**: SSD vs HDD vs NVMe
2. **不同内存大小**: 测试不同tmpfs大小
3. **不同数据集**: 使用不同大小的数据集
4. **不同算法**: 测试不同Faiss索引类型

## 总结

这个对比实验能够有效识别磁盘I/O是否是系统性能瓶颈，为系统优化提供数据支持。通过内存磁盘的极高性能，可以验证纯计算性能的上限，从而判断存储系统是否限制了整体性能。
