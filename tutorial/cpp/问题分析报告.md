# ç¨‹åºå´©æºƒé—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“‹ é—®é¢˜ç°è±¡

ç¨‹åºåœ¨å†…å­˜ç£ç›˜æµ‹è¯•é˜¶æ®µå‘ç”Ÿå´©æºƒï¼š
- **é”™è¯¯ä¿¡æ¯**: `Aborted (core dumped)`
- **é€€å‡ºç **: 134 (é€šå¸¸è¡¨ç¤ºæ®µé”™è¯¯æˆ–æ–­è¨€å¤±è´¥)
- **å´©æºƒä½ç½®**: å†…å­˜ç£ç›˜æµ‹è¯•ï¼Œæ™®é€šç£ç›˜æµ‹è¯•æ­£å¸¸å®Œæˆ

## ğŸ” æ ¹æœ¬åŸå› 

### 1. **å†…å­˜ç£ç›˜ç©ºé—´ä¸è¶³**

```bash
# é…ç½®çš„å†…å­˜ç£ç›˜å¤§å°
tmpfs           2.0G     0  2.0G   0% /home/gpu/dry/faiss/tutorial/cpp/memory_workspace

# å®é™…éœ€è¦çš„ç©ºé—´
æ•°æ®ç›®å½•æ€»å¤§å°çº¦ 2.5GBï¼š
- base_d128_nlist15625_HNSWM32_efc100_IVFFlat.index: 508MB
- base_d128_nlist3906_HNSWM32_efc40_IndexIVFHNSW.index: 499MB
- base_d128_nlist3906_HNSWM32_efc40_IVFFlat.index: 499MB
- base_d128_nlist40000_HNSWM32_efc100_IVFFlat.index: 526MB âš ï¸
- base.fbin: 488MB
- query.fbin: 5MB
- learn.fbin: 49MB
- groundtruth.ivecs: 4MB
```

**ç»“è®º**: 2GB < 2.5GBï¼Œç©ºé—´ä¸è¶³å¯¼è‡´æ–‡ä»¶å¤åˆ¶å¤±è´¥

### 2. **æ–‡ä»¶å¤åˆ¶å¤±è´¥**

å¤åˆ¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š
```
cp: error writing './memory_workspace/sift/base_d128_nlist3906_HNSWM32_efc40_IVFFlat.index': No space left on device
cp: error writing './memory_workspace/sift/base_d128_nlist40000_HNSWM32_efc100_IVFFlat.index': No space left on device
```

å¯¼è‡´çš„ç»“æœï¼š
- `base_d128_nlist40000_HNSWM32_efc100_IVFFlat.index` â†’ **0å­—èŠ‚**ï¼ˆå®Œå…¨å¤±è´¥ï¼‰
- `base_d128_nlist3906_HNSWM32_efc40_IVFFlat.index` â†’ 519MBï¼ˆéƒ¨åˆ†å¤åˆ¶ï¼ŒåŸå§‹523MBï¼‰

### 3. **ç¨‹åºå´©æºƒé“¾è·¯**

```cpp
// benchmark-thread.cpp ç¬¬406è¡Œ
faiss::Index* index_final = faiss::read_index(INDEX_FILE.c_str(), IO_FLAG_MMAP);
```

**å´©æºƒåŸå› **:
1. ç¨‹åºå°è¯•ä½¿ç”¨mmapæ–¹å¼è¯»å–ç´¢å¼•æ–‡ä»¶
2. ç´¢å¼•æ–‡ä»¶å¤§å°ä¸º0å­—èŠ‚æˆ–ä¸å®Œæ•´
3. Faissåº“åœ¨è§£ææŸåçš„ç´¢å¼•æ–‡ä»¶æ—¶è§¦å‘æ–­è¨€å¤±è´¥
4. ç¨‹åºæ”¶åˆ°SIGABRTä¿¡å·ï¼Œäº§ç”Ÿcore dump

## âœ… è§£å†³æ–¹æ¡ˆ

æˆ‘å·²ç»å®æ–½äº†ä»¥ä¸‹4ä¸ªä¿®å¤æªæ–½ï¼š

### ä¿®å¤1: å¢åŠ å†…å­˜ç£ç›˜å¤§å°
```bash
# ä¿®æ”¹å‰
sudo mount -t tmpfs -o size=2G tmpfs "$MEMORY_DIR"

# ä¿®æ”¹å
sudo mount -t tmpfs -o size=4G tmpfs "$MEMORY_DIR"
```

### ä¿®å¤2: æ·»åŠ æ–‡ä»¶å¤åˆ¶é”™è¯¯æ£€æŸ¥
```bash
cp -r ./sift "$MEMORY_DIR/"

if [ $? -ne 0 ]; then
    echo "âŒ å¤åˆ¶æ•°æ®åˆ°å†…å­˜ç£ç›˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç©ºé—´ä¸è¶³"
    echo "å½“å‰å†…å­˜ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š"
    df -h "$MEMORY_DIR"
    sudo umount "$MEMORY_DIR" 2>/dev/null
    exit 1
fi
```

### ä¿®å¤3: æ·»åŠ æ–‡ä»¶å®Œæ•´æ€§éªŒè¯
```bash
# éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
DISK_SIZE=$(du -sb "$DISK_DIR/sift" | cut -f1)
MEMORY_SIZE=$(du -sb "$MEMORY_DIR/sift" | cut -f1)

if [ "$DISK_SIZE" != "$MEMORY_SIZE" ]; then
    echo "âš ï¸  è­¦å‘Š: ä¸¤ä¸ªç›®å½•çš„æ•°æ®å¤§å°ä¸ä¸€è‡´ï¼"
    exit 1
fi
```

### ä¿®å¤4: åœ¨C++ä»£ç ä¸­æ·»åŠ ç´¢å¼•æ–‡ä»¶éªŒè¯
```cpp
// éªŒè¯ç´¢å¼•æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
ifstream index_verify(INDEX_FILE, ios::binary | ios::ate);
if (!index_verify.is_open()) {
    throw runtime_error("æ— æ³•æ‰“å¼€ç´¢å¼•æ–‡ä»¶: " + INDEX_FILE);
}
size_t index_file_size = index_verify.tellg();
index_verify.close();

if (index_file_size == 0) {
    throw runtime_error("ç´¢å¼•æ–‡ä»¶ä¸ºç©ºæˆ–æŸå: " + INDEX_FILE + " (å¤§å°: 0 å­—èŠ‚)");
}
```

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. æ¸…ç†æ—§çš„æµ‹è¯•ç¯å¢ƒï¼ˆéœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼‰
```bash
cd /home/gpu/dry/faiss/tutorial/cpp
sudo umount memory_workspace
sudo umount memory_workspace  # å¦‚æœæœ‰é‡å¤æŒ‚è½½ï¼Œéœ€è¦å¤šæ¬¡å¸è½½
rm -rf memory_workspace disk_workspace
```

### 2. é‡æ–°ç¼–è¯‘ç¨‹åº
```bash
cd /home/gpu/dry/faiss/tutorial/cpp
g++ -std=c++17 -O3 -o benchmark-thread benchmark-thread.cpp \
    -I ../.. -L ../../build/faiss \
    -Wl,-rpath,../../build/faiss -lfaiss -lopenblas -fopenmp
```

### 3. é‡æ–°è¿è¡Œæµ‹è¯•
```bash
./simple_disk_memory_test.sh
```

## ğŸ“Š é¢„æœŸç»“æœ

ä¿®å¤åï¼Œè„šæœ¬åº”è¯¥èƒ½å¤Ÿï¼š
1. âœ… æˆåŠŸåˆ›å»º4GBçš„å†…å­˜ç£ç›˜
2. âœ… å®Œæ•´å¤åˆ¶æ‰€æœ‰æ•°æ®æ–‡ä»¶ï¼ˆçº¦2.5GBï¼‰
3. âœ… éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
4. âœ… æˆåŠŸè¿è¡Œæ™®é€šç£ç›˜æµ‹è¯•
5. âœ… æˆåŠŸè¿è¡Œå†…å­˜ç£ç›˜æµ‹è¯•
6. âœ… ç”Ÿæˆæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š

## ğŸ’¡ ç»éªŒæ•™è®­

1. **é¢„ç•™ç¼“å†²ç©ºé—´**: ä¸ºå†…å­˜ç£ç›˜åˆ†é…ç©ºé—´æ—¶ï¼Œåº”è¯¥é¢„ç•™è‡³å°‘20%çš„ç¼“å†²ç©ºé—´
2. **é”™è¯¯æ£€æŸ¥**: æ¯ä¸ªå…³é”®æ“ä½œï¼ˆæ–‡ä»¶å¤åˆ¶ã€æŒ‚è½½ç­‰ï¼‰éƒ½åº”è¯¥æ£€æŸ¥è¿”å›å€¼
3. **æ–‡ä»¶éªŒè¯**: åœ¨ä½¿ç”¨æ–‡ä»¶å‰éªŒè¯å…¶å®Œæ•´æ€§ï¼Œé¿å…ä½¿ç”¨æŸåçš„æ–‡ä»¶
4. **ä¼˜é›…é™çº§**: åœ¨æ–‡ä»¶æ“ä½œå¤±è´¥æ—¶ï¼Œåº”è¯¥æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œæ¸…ç†æ“ä½œ

## ğŸ”§ ç³»ç»Ÿè¦æ±‚éªŒè¯

ä¸ºç¡®ä¿å®éªŒé¡ºåˆ©è¿›è¡Œï¼Œè¯·ç¡®è®¤ï¼š
- [ ] ç³»ç»Ÿå¯ç”¨å†…å­˜ â‰¥ 6GBï¼ˆ4GBç”¨äºtmpfs + 2GBç³»ç»Ÿè¿è¡Œï¼‰
- [ ] ç£ç›˜å¯ç”¨ç©ºé—´ â‰¥ 3GBï¼ˆç”¨äºdisk_workspaceï¼‰
- [ ] å…·æœ‰sudoæƒé™ï¼ˆç”¨äºåˆ›å»ºå’Œå¸è½½tmpfsï¼‰

æ£€æŸ¥å‘½ä»¤ï¼š
```bash
# æ£€æŸ¥å¯ç”¨å†…å­˜
free -h | grep Mem

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h .

# æ£€æŸ¥æ•°æ®ç›®å½•å¤§å°
du -sh ./sift
```

