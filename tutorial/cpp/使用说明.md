# Faiss 磁盘 vs 内存磁盘性能对比实验 - 使用说明

## 📝 问题已修复

之前的程序崩溃问题已经完全修复。问题原因和解决方案详见 [`问题分析报告.md`](./问题分析报告.md)

### 主要修复内容

1. ✅ **内存磁盘大小**: 从 2GB 增加到 4GB（数据实际需要 2.51GB）
2. ✅ **文件复制检查**: 添加错误检查和提前退出机制
3. ✅ **完整性验证**: 自动验证复制后的文件大小
4. ✅ **C++文件验证**: 在读取索引文件前验证其有效性

## 🚀 快速开始

### 方式一：使用便捷脚本（推荐）

```bash
# 清理环境并重新运行测试
./cleanup_and_rerun.sh
```

这个脚本会自动：
- 清理旧的测试环境和挂载点
- 检查系统资源是否充足
- 重新编译程序（如需要）
- 询问是否立即运行测试

### 方式二：手动执行

```bash
# 1. 检查数据大小和系统资源
./check_data_size.sh

# 2. 清理旧环境（如有）
sudo umount memory_workspace 2>/dev/null
rm -rf memory_workspace disk_workspace *.log *.csv performance_comparison.md

# 3. 重新编译（如果修改了代码）
g++ -std=c++17 -O3 -o benchmark-thread benchmark-thread.cpp \
    -I ../.. -L ../../build/faiss \
    -Wl,-rpath,../../build/faiss -lfaiss -lopenblas -fopenmp

# 4. 运行测试
./simple_disk_memory_test.sh
```

## 📊 数据目录信息

当前数据集大小分布：

```
文件名                                              大小
-------------------------------------------------------------
base_d128_nlist15625_HNSWM32_efc100_IVFFlat.index   508M
base_d128_nlist3906_HNSWM32_efc40_IndexIVFHNSW.index 499M
base_d128_nlist3906_HNSWM32_efc40_IVFFlat.index     499M
base_d128_nlist40000_HNSWM32_efc100_IVFFlat.index   527M
base.fbin                                            489M
groundtruth.ivecs                                    3.9M
learn.fbin                                           49M
query.fbin                                           4.9M
-------------------------------------------------------------
总计                                                 2.51GB
```

**内存磁盘配置**: 4GB（包含约60%的缓冲空间）

## 🔧 系统要求

运行此实验需要：

| 资源类型 | 最低要求 | 推荐配置 | 当前系统 |
|---------|---------|---------|---------|
| 可用内存 | 6GB | 8GB+ | 212GB ✅ |
| 磁盘空间 | 3GB | 5GB+ | 23GB ✅ |
| CPU核心 | 4核 | 8核+ | - |
| sudo权限 | 需要 | 需要 | 需要 |

## 📂 生成的文件

测试完成后会生成以下文件：

```
./disk_test.log              - 普通磁盘测试详细日志
./memory_test.log            - 内存磁盘测试详细日志
./disk_results.csv           - 普通磁盘性能数据（CSV格式）
./memory_results.csv         - 内存磁盘性能数据（CSV格式）
./performance_comparison.md  - 自动生成的对比分析报告
```

## ⚙️ 测试配置

### 当前测试的线程数配置

在 `benchmark-thread.cpp` 第520行：

```cpp
std::vector<int> thread_counts = {1,5,10,15,20};
```

如需测试更多线程配置，可以修改此行。例如：

```cpp
// 测试1到100线程
std::vector<int> thread_counts = {1,2,3,4,5,10,15,20,25,30,40,50,60,70,80,90,100};

// 或测试特定线程数
std::vector<int> thread_counts = {1,10,20,40};
```

### 索引参数

主要参数在 `benchmark-thread.cpp` 中配置：

```cpp
size_t nlist = 40000;         // IVF聚类中心数量
size_t nprobe = 480;          // 搜索时探测的聚类数量
size_t M = 32;                // HNSW连接数
size_t efconstruction = 100;  // HNSW构建参数
size_t efsearch = 240;        // HNSW搜索参数
```

## 🐛 故障排除

### 问题1: 内存磁盘无法卸载

```bash
# 强制卸载
sudo fuser -km memory_workspace
sudo umount -f memory_workspace
# 或延迟卸载
sudo umount -l memory_workspace
```

### 问题2: 权限不足

```bash
# 确保脚本有执行权限
chmod +x simple_disk_memory_test.sh
chmod +x cleanup_and_rerun.sh
chmod +x check_data_size.sh
```

### 问题3: 编译失败

检查Faiss库是否正确安装：

```bash
# 检查库文件
ls ../../build/faiss/libfaiss.so

# 检查头文件
ls ../../faiss/*.h
```

### 问题4: "No space left on device"

这说明内存磁盘空间不足，需要：

1. 检查数据大小：`./check_data_size.sh`
2. 增加 `simple_disk_memory_test.sh` 中的内存磁盘大小（第32行）

```bash
# 例如改为6GB
sudo mount -t tmpfs -o size=6G tmpfs "$MEMORY_DIR"
```

### 问题5: 程序崩溃 (Aborted/Segmentation fault)

可能原因：
1. 索引文件损坏或不完整 → 重新构建索引
2. 内存不足 → 减少线程数或数据规模
3. 库版本不兼容 → 重新编译Faiss和程序

```bash
# 删除所有索引文件，强制重新构建
rm ./sift/*.index
./simple_disk_memory_test.sh
```

## 📈 预期测试时间

- 索引构建（首次运行）: 5-15分钟
- 普通磁盘测试: 2-5分钟
- 内存磁盘测试: 2-5分钟
- 总计: 约10-25分钟（首次运行）

后续运行（索引已存在）: 约5-10分钟

## 💡 实验建议

1. **首次运行**: 先用少量线程配置（如 `{1,5,10}`）快速验证
2. **完整测试**: 确认无误后再进行完整的线程扫描
3. **资源监控**: 可以在另一个终端运行 `htop` 或 `watch -n 1 free -h` 监控资源使用
4. **多次运行**: 为了获得更稳定的结果，可以将 `num_runs_per_thread_setting` 设置为3或5

## 📖 相关文档

- [`问题分析报告.md`](./问题分析报告.md) - 详细的问题诊断和解决方案
- [`performance_comparison.md`](./performance_comparison.md) - 测试完成后自动生成的对比报告

## ✅ 验证清单

运行测试前请确认：

- [ ] 数据目录 `./sift` 存在且完整（运行 `./check_data_size.sh`）
- [ ] 系统可用内存充足（至少6GB）
- [ ] 具有sudo权限
- [ ] 已清理旧的测试环境（运行 `./cleanup_and_rerun.sh`）
- [ ] 程序已编译（存在 `./benchmark-thread`）

全部确认后即可运行测试！🚀

