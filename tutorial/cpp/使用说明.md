# Faiss ç£ç›˜ vs å†…å­˜ç£ç›˜æ€§èƒ½å¯¹æ¯”å®éªŒ - ä½¿ç”¨è¯´æ˜

## ğŸ“ é—®é¢˜å·²ä¿®å¤

ä¹‹å‰çš„ç¨‹åºå´©æºƒé—®é¢˜å·²ç»å®Œå…¨ä¿®å¤ã€‚é—®é¢˜åŸå› å’Œè§£å†³æ–¹æ¡ˆè¯¦è§ [`é—®é¢˜åˆ†ææŠ¥å‘Š.md`](./é—®é¢˜åˆ†ææŠ¥å‘Š.md)

### ä¸»è¦ä¿®å¤å†…å®¹

1. âœ… **å†…å­˜ç£ç›˜å¤§å°**: ä» 2GB å¢åŠ åˆ° 4GBï¼ˆæ•°æ®å®é™…éœ€è¦ 2.51GBï¼‰
2. âœ… **æ–‡ä»¶å¤åˆ¶æ£€æŸ¥**: æ·»åŠ é”™è¯¯æ£€æŸ¥å’Œæå‰é€€å‡ºæœºåˆ¶
3. âœ… **å®Œæ•´æ€§éªŒè¯**: è‡ªåŠ¨éªŒè¯å¤åˆ¶åçš„æ–‡ä»¶å¤§å°
4. âœ… **C++æ–‡ä»¶éªŒè¯**: åœ¨è¯»å–ç´¢å¼•æ–‡ä»¶å‰éªŒè¯å…¶æœ‰æ•ˆæ€§

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ä¾¿æ·è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æ¸…ç†ç¯å¢ƒå¹¶é‡æ–°è¿è¡Œæµ‹è¯•
./cleanup_and_rerun.sh
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ¸…ç†æ—§çš„æµ‹è¯•ç¯å¢ƒå’ŒæŒ‚è½½ç‚¹
- æ£€æŸ¥ç³»ç»Ÿèµ„æºæ˜¯å¦å……è¶³
- é‡æ–°ç¼–è¯‘ç¨‹åºï¼ˆå¦‚éœ€è¦ï¼‰
- è¯¢é—®æ˜¯å¦ç«‹å³è¿è¡Œæµ‹è¯•

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œ

```bash
# 1. æ£€æŸ¥æ•°æ®å¤§å°å’Œç³»ç»Ÿèµ„æº
./check_data_size.sh

# 2. æ¸…ç†æ—§ç¯å¢ƒï¼ˆå¦‚æœ‰ï¼‰
sudo umount memory_workspace 2>/dev/null
rm -rf memory_workspace disk_workspace *.log *.csv performance_comparison.md

# 3. é‡æ–°ç¼–è¯‘ï¼ˆå¦‚æœä¿®æ”¹äº†ä»£ç ï¼‰
g++ -std=c++17 -O3 -o benchmark-thread benchmark-thread.cpp \
    -I ../.. -L ../../build/faiss \
    -Wl,-rpath,../../build/faiss -lfaiss -lopenblas -fopenmp

# 4. è¿è¡Œæµ‹è¯•
./simple_disk_memory_test.sh
```

## ğŸ“Š æ•°æ®ç›®å½•ä¿¡æ¯

å½“å‰æ•°æ®é›†å¤§å°åˆ†å¸ƒï¼š

```
æ–‡ä»¶å                                              å¤§å°
-------------------------------------------------------------
base_d128_nlist15625_HNSWM32_efc100_IVFFlat.index   508M
base_d128_nlist3906_HNSWM32_efc40_IndexIVFHNSW.index 499M
base_d128_nlist3906_HNSWM32_efc40_IVFFlat.index     499M
base_d128_nlist40000_HNSWM32_efc100_IVFFlat.index   527M
base.fbin                                            489M
groundtruth.ivecs                                    3.9M
learn.fbin                                           49M
query.fbin                                           4.9M
-------------------------------------------------------------
æ€»è®¡                                                 2.51GB
```

**å†…å­˜ç£ç›˜é…ç½®**: 4GBï¼ˆåŒ…å«çº¦60%çš„ç¼“å†²ç©ºé—´ï¼‰

## ğŸ”§ ç³»ç»Ÿè¦æ±‚

è¿è¡Œæ­¤å®éªŒéœ€è¦ï¼š

| èµ„æºç±»å‹ | æœ€ä½è¦æ±‚ | æ¨èé…ç½® | å½“å‰ç³»ç»Ÿ |
|---------|---------|---------|---------|
| å¯ç”¨å†…å­˜ | 6GB | 8GB+ | 212GB âœ… |
| ç£ç›˜ç©ºé—´ | 3GB | 5GB+ | 23GB âœ… |
| CPUæ ¸å¿ƒ | 4æ ¸ | 8æ ¸+ | - |
| sudoæƒé™ | éœ€è¦ | éœ€è¦ | éœ€è¦ |

## ğŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶

æµ‹è¯•å®Œæˆåä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
./disk_test.log              - æ™®é€šç£ç›˜æµ‹è¯•è¯¦ç»†æ—¥å¿—
./memory_test.log            - å†…å­˜ç£ç›˜æµ‹è¯•è¯¦ç»†æ—¥å¿—
./disk_results.csv           - æ™®é€šç£ç›˜æ€§èƒ½æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰
./memory_results.csv         - å†…å­˜ç£ç›˜æ€§èƒ½æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰
./performance_comparison.md  - è‡ªåŠ¨ç”Ÿæˆçš„å¯¹æ¯”åˆ†ææŠ¥å‘Š
```

## âš™ï¸ æµ‹è¯•é…ç½®

### å½“å‰æµ‹è¯•çš„çº¿ç¨‹æ•°é…ç½®

åœ¨ `benchmark-thread.cpp` ç¬¬520è¡Œï¼š

```cpp
std::vector<int> thread_counts = {1,5,10,15,20};
```

å¦‚éœ€æµ‹è¯•æ›´å¤šçº¿ç¨‹é…ç½®ï¼Œå¯ä»¥ä¿®æ”¹æ­¤è¡Œã€‚ä¾‹å¦‚ï¼š

```cpp
// æµ‹è¯•1åˆ°100çº¿ç¨‹
std::vector<int> thread_counts = {1,2,3,4,5,10,15,20,25,30,40,50,60,70,80,90,100};

// æˆ–æµ‹è¯•ç‰¹å®šçº¿ç¨‹æ•°
std::vector<int> thread_counts = {1,10,20,40};
```

### ç´¢å¼•å‚æ•°

ä¸»è¦å‚æ•°åœ¨ `benchmark-thread.cpp` ä¸­é…ç½®ï¼š

```cpp
size_t nlist = 40000;         // IVFèšç±»ä¸­å¿ƒæ•°é‡
size_t nprobe = 480;          // æœç´¢æ—¶æ¢æµ‹çš„èšç±»æ•°é‡
size_t M = 32;                // HNSWè¿æ¥æ•°
size_t efconstruction = 100;  // HNSWæ„å»ºå‚æ•°
size_t efsearch = 240;        // HNSWæœç´¢å‚æ•°
```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1: å†…å­˜ç£ç›˜æ— æ³•å¸è½½

```bash
# å¼ºåˆ¶å¸è½½
sudo fuser -km memory_workspace
sudo umount -f memory_workspace
# æˆ–å»¶è¿Ÿå¸è½½
sudo umount -l memory_workspace
```

### é—®é¢˜2: æƒé™ä¸è¶³

```bash
# ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x simple_disk_memory_test.sh
chmod +x cleanup_and_rerun.sh
chmod +x check_data_size.sh
```

### é—®é¢˜3: ç¼–è¯‘å¤±è´¥

æ£€æŸ¥Faissåº“æ˜¯å¦æ­£ç¡®å®‰è£…ï¼š

```bash
# æ£€æŸ¥åº“æ–‡ä»¶
ls ../../build/faiss/libfaiss.so

# æ£€æŸ¥å¤´æ–‡ä»¶
ls ../../faiss/*.h
```

### é—®é¢˜4: "No space left on device"

è¿™è¯´æ˜å†…å­˜ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦ï¼š

1. æ£€æŸ¥æ•°æ®å¤§å°ï¼š`./check_data_size.sh`
2. å¢åŠ  `simple_disk_memory_test.sh` ä¸­çš„å†…å­˜ç£ç›˜å¤§å°ï¼ˆç¬¬32è¡Œï¼‰

```bash
# ä¾‹å¦‚æ”¹ä¸º6GB
sudo mount -t tmpfs -o size=6G tmpfs "$MEMORY_DIR"
```

### é—®é¢˜5: ç¨‹åºå´©æºƒ (Aborted/Segmentation fault)

å¯èƒ½åŸå› ï¼š
1. ç´¢å¼•æ–‡ä»¶æŸåæˆ–ä¸å®Œæ•´ â†’ é‡æ–°æ„å»ºç´¢å¼•
2. å†…å­˜ä¸è¶³ â†’ å‡å°‘çº¿ç¨‹æ•°æˆ–æ•°æ®è§„æ¨¡
3. åº“ç‰ˆæœ¬ä¸å…¼å®¹ â†’ é‡æ–°ç¼–è¯‘Faisså’Œç¨‹åº

```bash
# åˆ é™¤æ‰€æœ‰ç´¢å¼•æ–‡ä»¶ï¼Œå¼ºåˆ¶é‡æ–°æ„å»º
rm ./sift/*.index
./simple_disk_memory_test.sh
```

## ğŸ“ˆ é¢„æœŸæµ‹è¯•æ—¶é—´

- ç´¢å¼•æ„å»ºï¼ˆé¦–æ¬¡è¿è¡Œï¼‰: 5-15åˆ†é’Ÿ
- æ™®é€šç£ç›˜æµ‹è¯•: 2-5åˆ†é’Ÿ
- å†…å­˜ç£ç›˜æµ‹è¯•: 2-5åˆ†é’Ÿ
- æ€»è®¡: çº¦10-25åˆ†é’Ÿï¼ˆé¦–æ¬¡è¿è¡Œï¼‰

åç»­è¿è¡Œï¼ˆç´¢å¼•å·²å­˜åœ¨ï¼‰: çº¦5-10åˆ†é’Ÿ

## ğŸ’¡ å®éªŒå»ºè®®

1. **é¦–æ¬¡è¿è¡Œ**: å…ˆç”¨å°‘é‡çº¿ç¨‹é…ç½®ï¼ˆå¦‚ `{1,5,10}`ï¼‰å¿«é€ŸéªŒè¯
2. **å®Œæ•´æµ‹è¯•**: ç¡®è®¤æ— è¯¯åå†è¿›è¡Œå®Œæ•´çš„çº¿ç¨‹æ‰«æ
3. **èµ„æºç›‘æ§**: å¯ä»¥åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œ `htop` æˆ– `watch -n 1 free -h` ç›‘æ§èµ„æºä½¿ç”¨
4. **å¤šæ¬¡è¿è¡Œ**: ä¸ºäº†è·å¾—æ›´ç¨³å®šçš„ç»“æœï¼Œå¯ä»¥å°† `num_runs_per_thread_setting` è®¾ç½®ä¸º3æˆ–5

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [`é—®é¢˜åˆ†ææŠ¥å‘Š.md`](./é—®é¢˜åˆ†ææŠ¥å‘Š.md) - è¯¦ç»†çš„é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ
- [`performance_comparison.md`](./performance_comparison.md) - æµ‹è¯•å®Œæˆåè‡ªåŠ¨ç”Ÿæˆçš„å¯¹æ¯”æŠ¥å‘Š

## âœ… éªŒè¯æ¸…å•

è¿è¡Œæµ‹è¯•å‰è¯·ç¡®è®¤ï¼š

- [ ] æ•°æ®ç›®å½• `./sift` å­˜åœ¨ä¸”å®Œæ•´ï¼ˆè¿è¡Œ `./check_data_size.sh`ï¼‰
- [ ] ç³»ç»Ÿå¯ç”¨å†…å­˜å……è¶³ï¼ˆè‡³å°‘6GBï¼‰
- [ ] å…·æœ‰sudoæƒé™
- [ ] å·²æ¸…ç†æ—§çš„æµ‹è¯•ç¯å¢ƒï¼ˆè¿è¡Œ `./cleanup_and_rerun.sh`ï¼‰
- [ ] ç¨‹åºå·²ç¼–è¯‘ï¼ˆå­˜åœ¨ `./benchmark-thread`ï¼‰

å…¨éƒ¨ç¡®è®¤åå³å¯è¿è¡Œæµ‹è¯•ï¼ğŸš€

