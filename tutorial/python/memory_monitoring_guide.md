# 高级内存监控指南

## 概述

我已经为您的Faiss测试脚本添加了高级内存监控功能，提供了比传统`resource.getrusage()`更精确和详细的内存分析。

## 新增功能

### 1. 高级内存监控类 (AdvancedMemoryMonitor)

**主要特性：**
- **实时内存监控**：使用`psutil`获取RSS（实际物理内存）和VMS（虚拟内存）使用情况
- **Python对象统计**：监控Python对象数量和垃圾回收情况
- **tracemalloc集成**：提供详细的内存分配跟踪
- **阶段化监控**：可以监控特定代码段的内存使用
- **CSV日志记录**：自动记录内存使用历史到文件

### 2. 监控指标

**基础指标：**
- RSS内存（实际物理内存使用）
- VMS内存（虚拟内存使用）
- 内存使用百分比
- Python对象数量
- 垃圾回收次数

**高级指标（启用tracemalloc时）：**
- 当前traced内存
- 峰值traced内存
- 内存分配热点分析

### 3. 使用方法

**启用详细内存监控：**
```python
ENABLE_DETAILED_MEMORY_MONITORING = True
```

**监控特定代码段：**
```python
with memory_monitor.monitor_phase("阶段名称"):
    # 您的代码
    pass
```

**强制垃圾回收并记录：**
```python
memory_monitor.force_gc_and_log("阶段名称")
```

## 相比传统方法的优势

### 传统方法 (resource.getrusage) 的局限性：
1. ❌ 只能获取整个进程的峰值内存
2. ❌ 无法监控特定代码段
3. ❌ 精度有限
4. ❌ 无法区分RSS和VMS内存
5. ❌ 无法获取Python对象统计

### 新方法的优势：
1. ✅ **精确监控**：实时获取RSS和VMS内存使用
2. ✅ **阶段化分析**：可以监控特定代码段的内存变化
3. ✅ **详细统计**：Python对象数量、垃圾回收情况
4. ✅ **热点分析**：tracemalloc提供内存分配热点
5. ✅ **历史记录**：CSV格式的内存使用日志
6. ✅ **自动垃圾回收**：在关键点自动进行垃圾回收
7. ✅ **灵活控制**：可以通过开关启用/禁用功能

## 输出示例

```
[内存监控] 训练HNSW粗量化器_开始: RSS=1234.56MB, VMS=2345.67MB, 对象数=12345
[内存监控] 训练HNSW粗量化器_结束: RSS=+100.23MB, VMS=+200.45MB, 对象数=+1000
[垃圾回收] 训练完成后: 释放RSS=50.12MB, 对象=500

详细内存分析:
  峰值RSS内存: 1500.00 MB
  峰值VMS内存: 3000.00 MB
  平均RSS内存: 1200.00 MB
  平均VMS内存: 2500.00 MB
  总监控快照数: 25

内存使用热点分析:
Top 10 内存使用最多的代码行:
1. /path/to/file.py:123: 100.5 MB
2. /path/to/file.py:456: 50.2 MB
...
```

## 配置选项

```python
# 内存监控开关
ENABLE_DETAILED_MEMORY_MONITORING = True
MEMORY_LOG_FILENAME = os.path.join(DATA_DIR, "memory_usage_log.txt")
```

## 依赖包

确保安装以下Python包：
```bash
pip install psutil
```

## 注意事项

1. **性能影响**：启用tracemalloc会有轻微的性能开销
2. **内存日志**：日志文件会随着监控次数增长，注意磁盘空间
3. **垃圾回收**：自动垃圾回收可能会影响性能测试的准确性
4. **兼容性**：在Linux和macOS上效果最佳

## 建议使用场景

1. **开发调试**：识别内存泄漏和内存使用热点
2. **性能优化**：分析不同阶段的内存使用模式
3. **资源规划**：了解程序的实际内存需求
4. **问题诊断**：当程序出现内存相关问题时进行详细分析

这个新的内存监控系统为您提供了比传统方法更全面、更精确的内存分析能力，帮助您更好地理解和优化程序的内存使用情况。
